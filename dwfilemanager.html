<!--
  DW File Manager (Diogenes File Manager for Woodland)
  Verion: 1.0
  Copyright (C) 2025 Diogenes

  This program is free software; you can redistribute it and/or
  modify it under the terms of the GNU General Public License
  as published by the Free Software Foundation; either version 2
  of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DW File Manager</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        font-family: sans-serif;
        background: #f0f0f0;
    }
    #app {
        display: flex;
        height: 100vh;
        width: 100vw;
    }
    #fileManager {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-right: 1px solid #ccc;
    }
    #controls {
        background: #ddd;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #fileList {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }
    button {
        padding: 6px 12px;
        cursor: pointer;
    }
    button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    li {
        list-style: none;
        padding: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-radius: 4px;
    }
li.selected {
    background: #444;      /* dark gray */
    color: #fff;
}
    li:hover {
        background: #e0e0e0;
    }
    #pathDisplay {
        flex: 1;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .icon {
        width: 16px;
        height: 16px;
        display: inline-block;
        text-align: center;
    }
    #preview {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #eee;
        overflow: auto;
    }
    #preview img {
        max-width: 100%;
        max-height: 100%;
    }
    #preview audio {
        width: 90%;
    }
</style>
</head>
<body>
<div id="app">
    <div id="fileManager">
        <div id="controls">
            <button id="chooseBtn">Choose Folder</button>
            <input type="file" id="folderInput" webkitdirectory hidden>
            <button id="backBtn" disabled>Back</button>
            <div id="pathDisplay">/</div>
        </div>
        <ul id="fileList"></ul>
    </div>
    <div id="preview">
        <span>Select a file to preview</span>
    </div>
</div>

<script>
const chooseBtn = document.getElementById('chooseBtn');
const folderInput = document.getElementById('folderInput');
const fileList = document.getElementById('fileList');
const backBtn = document.getElementById('backBtn');
const pathDisplay = document.getElementById('pathDisplay');
const preview = document.getElementById('preview');

let root = null;
let tree = {};
let currentPath = [];
let entries = [];
let selectedIndex = 0;

chooseBtn.addEventListener('click', () => folderInput.click());

folderInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    tree = buildTree(files);
    root = Object.keys(tree)[0];
    currentPath = [root];
    selectedIndex = 0;
    render();
});

backBtn.addEventListener('click', goBack);

function buildTree(files) {
    let tree = {};
    files.forEach(file => {
        let parts = file.webkitRelativePath.split("/");
        let current = tree;
        parts.forEach((part, i) => {
            if (!current[part]) current[part] = (i === parts.length - 1) ? file : {};
            current = current[part];
        });
    });
    return tree;
}

function getCurrentDir() {
    let current = tree;
    for (let i = 0; i < currentPath.length; i++) {
        current = current[currentPath[i]];
    }
    return current;
}

function openEntry(index){
    const [name, value] = entries[index];
    if(!value) return;

    if(value instanceof File){
        const type = value.type;

        if(type.startsWith('video/')){
            // Videos open in a new tab
            const blobURL = URL.createObjectURL(value);
            const newTab = window.open();
            newTab.document.write(`
            <!DOCTYPE html>
            <html>
            <head><title>${value.name}</title></head>
            <body style="margin:0;display:flex;justify-content:center;align-items:center;height:100vh;background:#000;">
            <video src="${blobURL}" controls autoplay style="height:100vh; width:auto; display:block; margin:auto;"></video>
            </body>
            </html>
            `);
        } else if(type.startsWith('audio/')){
            // Audio plays in the preview pane
            preview.innerHTML = '';
            const audio = document.createElement('audio');
            audio.src = URL.createObjectURL(value);
            audio.controls = true;
            audio.autoplay = true;
            preview.appendChild(audio);
        } else if(type.startsWith('image/')){
            // Images preview in the right pane
            preview.innerHTML = '';
            const img = document.createElement('img');
            img.src = URL.createObjectURL(value);
            preview.appendChild(img);
        } else {
            // Other files open in a new tab
            window.open(URL.createObjectURL(value), '_blank');
        }
    } else {
        // Folders
        currentPath.push(name);
        selectedIndex = 0;
        render();
    }
}

function render() {
    const dir = getCurrentDir();
    fileList.innerHTML = '';
    entries = Object.entries(dir).sort((a,b) => {
        const aIsFile = a[1] instanceof File;
        const bIsFile = b[1] instanceof File;
        if(aIsFile === bIsFile) return a[0].localeCompare(b[0]);
        return aIsFile ? 1 : -1;
    });

	entries.forEach(([name, value], index) => {
		const li = document.createElement('li');
		const icon = document.createElement('span');
		icon.classList.add('icon');

		if(value instanceof File){
		    if(value.type.startsWith('audio/')) icon.textContent = 'ðŸŽµ';
		    else if(value.type.startsWith('video/')) icon.textContent = 'ðŸŽ¬';
		    else if(value.type.startsWith('image/')) icon.textContent = 'ðŸ–¼ï¸';
		    else icon.textContent = 'ðŸ“„';
		} else {
		    icon.textContent = 'ðŸ“';
		}

		li.appendChild(icon);
		const text = document.createElement('span');
		text.textContent = name;
		li.appendChild(text);

		// click handler updates selection color
		li.addEventListener('click', () => {
			selectedIndex = index;
			updateSelection();
			openEntry(index);
		});

		fileList.appendChild(li); // <<< missing in your snippet
	});

    pathDisplay.textContent = '/' + currentPath.join('/');
    backBtn.disabled = (currentPath.length <= 1);
    updateSelection();
    clearPreviewIfFolder();
}

function goBack(){
    if(currentPath.length > 1){
        currentPath.pop();
        selectedIndex = 0;
        render();
    }
}

function previewEntry(index){
    const [name, value] = entries[index];
    if(!value) return;

    if(value instanceof File){
        const url = URL.createObjectURL(value);
        if(value.type.startsWith('image/')){
            preview.innerHTML = '';
            const img = document.createElement('img');
            img.src = url;
            preview.appendChild(img);
        } else if(value.type.startsWith('audio/')){
            preview.innerHTML = '';
            const audio = document.createElement('audio');
            audio.src = url;
            audio.controls = true;
            audio.autoplay = true;
            preview.appendChild(audio);
        } else {
            preview.innerHTML = '<span>Press Enter to open this file</span>';
        }
    } else {
        preview.innerHTML = '<span>Select a file to preview</span>';
    }
}

function updateSelection(){
    Array.from(fileList.children).forEach((li,i)=>{
        li.classList.toggle('selected', i === selectedIndex);
    });
	previewEntry(selectedIndex);
}

document.addEventListener('keydown', (e) => {
    if(entries.length === 0) return;

    if(e.key === 'ArrowDown'){
        selectedIndex = (selectedIndex+1) % entries.length;
        updateSelection();
        fileList.children[selectedIndex].scrollIntoView({block:'nearest'});
        e.preventDefault();
    } else if(e.key === 'ArrowUp'){
        selectedIndex = (selectedIndex-1+entries.length) % entries.length;
        updateSelection();
        fileList.children[selectedIndex].scrollIntoView({block:'nearest'});
        e.preventDefault();
    } else if(e.key === 'Enter'){
        openEntry(selectedIndex);
        e.preventDefault();
    } else if(e.key === 'Backspace'){
        goBack();
        e.preventDefault();
    }
});

function clearPreviewIfFolder(){
    const [name, value] = entries[selectedIndex] || [];
    if(value && !(value instanceof File)){
        preview.innerHTML = '<span>Select a file to preview</span>';
    }
}
</script>
</body>
</html>
